<html>
<style>

    .line {
        fill: none;
        stroke: #000;
        stroke-width: 1.5px;
    }

</style>


<link href="examples.css" rel="stylesheet" type="text/css">
<script language="javascript" type="text/javascript" src="d3/d3.js"></script>
<script language="javascript" type="text/javascript" src="jquery.js"></script>

<script type="text/javascript">
    var sample_rate = 1000,
        fft_res=501,

        data0 = Array.apply(null, new Array(sample_rate)).map(Number.prototype.valueOf, 512), //RAW_L
        data1 = Array.apply(null, new Array(sample_rate)).map(Number.prototype.valueOf, 512), //RAW_R
        data2 = Array.apply(null, new Array(fft_res)).map(Number.prototype.valueOf, 0), //EEG_L
        data3 = Array.apply(null, new Array(fft_res)).map(Number.prototype.valueOf, 0), //EEG_R
        data4 = Array.apply(null, new Array(sample_rate)).map(Number.prototype.valueOf, 512), //PPG
/*        data5 = Array.apply(null, new Array(n)).map(Number.prototype.valueOf, 32),
        data6 = Array.apply(null, new Array(n/2+1)).map(Number.prototype.valueOf, 0),
        data7 = Array.apply(null, new Array(n/2+1)).map(Number.prototype.valueOf, 0),*/
        line,
        line2,
        x,
        y,
        y2,
        chart0,
        chart1,
        chart2,
        chart3,
        chart4,
        chart5,
        chart6,
        chart7,
        queue=[],// contains all peaks corresponding time (ORDERED, in ms) in the PPG's previous 10seconds
        hr;

    //------------------------------------------------------------

    function getPosition(string, subString, index) {
        return string.split(subString, index).join(subString).length;
    }
    // Establish a connection to the ServerBIT
    var ws = new WebSocket("ws://localhost:9005");
    // Define the boolean data type as used in Python
    var True = true;
    var False = false;

    ws.onopen = function () {
    };

    // Process the responses sent by the ServertBIT
    ws.onmessage = function (e) {
        msg = e.data.toString();

        // Log the response onto the HTML body
        if (msg.indexOf("read") < 0) {
            $("body").html($("body").html() + msg + "<br/>")
        }
        // Evaluate the respose
        //var unprocessed_data = e.data.substring(0,getPosition(e.data,'[',8));

        eval(e.data)
    };

    // Detect when the page is unloaded or close
    window.onbeforeunload = function () {
        // Request ServerBIT to close the connection to BITalino
        ws.send("device.close()");

        // Request ServerBIT to shut down
        ws.send("server.shutdown()");

        ws.onclose = function () {
        };
        ws.close()
    };

    // Process the server messages related with the server
    server = new function () {
        this.connected = function (msg) {
            // When a connection to ServerBIT is established, open the connection to the device
            ws.send("server.BITalino('20:15:12:22:81:23')")
        };
        this.BITalino = function (msg) {
            if (msg) {
                // When a connection to the device is established start the acquisition
                ws.send("device.start(1000, [0,1,2,3,4,5])")
            }
        }
    };

    // Process the server messages related with the <device></device>
    device = new function () {
        var auxv = 0;
        this.start = function (msg) {
            // When the device starts the acquisition read samples
            ws.send("device.read(1000)[:,-6:]")
        };
        this.read = function (msg) {
            // When a set of samples is read request more samples
            ws.send("device.read(1000)[:,-6:]");
            var dimensions = [ msg.length, msg[0].length ];

            var in0 = msg[0]; //RAW_LEFT
            var in1 = msg[1]; //RAW_RIGHT
            var in2 = msg[2]; //PPG
            var in3 = msg[3]; //AAC_X
            var in4 = msg[4]; //AAC_Y
            var in5 = msg[5]; //AAC_Z
            var in6 = msg[6]; //EEG_LEFT
            var in7 = msg[7]; //EEG_RIGHT
            data2=msg[6];
            data3=msg[7];

            createRTInfoVis(in0, in1, in2, in3, in4, in5,in6,in7);
            function estimateHR(){
                var aux_queue=[];
                queue = queue.map(function(x) { return x+1000;});//update time of previous peak occurance (they are now 1sec late)
                var pos = in2.indexOf(1023); //LOOK FOR PEAK OCCURENCEs
                while (~pos) {  //This bitwise not operator returns false if -1 and true if positive. A perfect match for indexOf which returns the index 0 ... n if found and -1 if not.
//                    console.log(new Date().toLocaleTimeString()+"="+pos);
                    aux_queue.push(pos);    //add peaks occurence QUEUE
                    pos = in2.indexOf(1023, pos + 1); // use old position incremented to keep searching for peak occurence
                }
                while(aux_queue.length>0){      //insert peak occurence in adequate order to queue
                    queue.push(aux_queue.pop());
                }
                while(queue[0]>10000){  //Remove peaks more than 10seconds' old
                    queue.shift()
                }
                var diff=0;
                var aux_comment=0;
                for(var i = 0; i<queue.length-1;i++){ //Add differences between each peak occurence
                    diff+=queue[i]-queue[i+1]
                    aux_comment+=1;
                }
/*                console.log("["+aux_comment+"]"+queue+"->"+ 60000/(diff*1.0/(queue.length-1)))

                console.log(diff + "diff")
                console.log(queue.length-1 + "queue.length-1")*/
                //averages the distances and converts this ms value to BPM HR
                return Math.floor(60000/(diff*1.0/(1.0*queue.length-1)));

            }
            function createRTInfoVis(a0, a1, a2, a3, a4, a5, a6, a7) {
                hr=estimateHR();
                var svg0 = d3.select("svg#RAW_LEFT");
                var svg1 = d3.select("svg#RAW_RIGHT");
                var svg2 = d3.select("svg#EEG_LEFT");
                var svg3 = d3.select("svg#EEG_RIGHT");
                var svg4 = d3.select("svg#PPG");
                var svg_ACC_X = d3.select("svg#ACC_X");
                var svg_AAC_Y = d3.select("svg#ACC_Y");
                var svg_AAC_Z = d3.select("svg#ACC_Z");

                // if previous plots already exists, remove them
                if (!svg0.select("g").empty()) { svg0.select("g").remove(); }
                if (!svg1.select("g").empty()) { svg1.select("g").remove(); }
                if (!svg2.select("g").empty()) { svg2.select("g").remove(); }
                if (!svg3.select("g").empty()) { svg3.select("g").remove(); }
                if (!svg4.select("g").empty()) { svg4.select("g").remove(); }

                if (!svg_ACC_X.select("g").empty()) {                        //if previous plots already exists
                    svg_ACC_X.select("g").remove()                         // remove them
                }
                if (!svg_AAC_Y.select("g").empty()) {                        //if previous plots already exists
                    svg_AAC_Y.select("g").remove()                         // remove them
                }
                if (!svg_AAC_Z.select("g").empty()) {                        //if previous plots already exists
                    svg_AAC_Z.select("g").remove()                         // remove them
                }

                //1console.log("after= " + svg.select("g").empty());

                var margin = {top: 20, right: 20, bottom: 20, left: 40},
                    width = +svg0.attr("width"),
                    height = +svg0.attr("height") - margin.top - margin.bottom;
                 svg0.append("text").attr("x", "50%").attr("y", "15%").attr("text-anchor", "middle")
                     .style("font-size", "16px").style("text-decoration", "underline").text("Left Electroencephalogram");
                 svg1.append("text").attr("x", "50%").attr("y","15%").attr("text-anchor", "middle")
                     .style("font-size", "16px").style("text-decoration", "underline").text("Right Electroencephalogram");
                 svg2.append("text").attr("x", "50%").attr("y", "15%").attr("text-anchor", "middle")
                     .style("font-size", "16px").style("text-decoration", "underline").text("Photoplethysmogram");
                 svg2.append("text").attr("x", "50%").attr("y", "22%").attr("text-anchor", "middle").attr("id","bpm_display")
                     .style("font-size", "16px").text("60 bpm");
                 svg3.append("text").attr("x", "50%").attr("y","15%").attr("text-anchor", "middle")
                     .style("font-size", "16px").style("text-decoration", "underline").text("Emotional Valence");
                 svg4.append("text").attr("x", "50%").attr("y", "15%").attr("text-anchor", "middle")
                     .style("font-size", "16px").style("text-decoration", "underline").text("Engagement");
                chart0 = svg0.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart1 = svg1.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart2 = svg2.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart3 = svg3.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart4 = svg4.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart5 = svg_ACC_X.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart6 = svg_AAC_Y.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                chart7 = svg_AAC_Z.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                x = d3.scaleLinear().domain([1, sample_rate-1]).range([0, width-margin.left*1.2]); //used for PPG & RAW INPUT
                x2 = d3.scaleLinear().domain([0, fft_res - 400 - 1]).range([0, width-margin.left*1.2]); //used for EEGs

                y = d3.scaleLinear()
                    .domain([1024, 0])
                    .range([0, height]);
                y2 = d3.scaleLinear()
                    .domain([100000, 0])
                    .range([0, height]);
                y3 = d3.scaleLinear()
                    .domain([64, 0])
                    .range([0, height]);

                line = d3.line()
                    .x(function (d, i) {
                        return x(i);
                    })
                    .y(function (d, i) {
                        return y(d);
                    });

                line2 = d3.line()
                    .x(function (d, i) {
                        return x2(i);
                    })
                    .y(function (d, i) {
                        return y2(d);
                    });
                line3 = d3.line()
                    .x(function(d, i){
                        return x2(d);
                    })
                    .y(function(d, i){
                       return y3(d);
                    });
                chart0.append("defs")
                    .append("clipPath")
                    .attr("id", "clip0") //attr must differ
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart0.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y(0) + ")")
                    .call(d3.axisBottom(x));
                chart0.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y));

                chart1.append("defs").append("clipPath")
                    .attr("id", "clip1")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart1.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y(0) + ")")
                    .call(d3.axisBottom(x));
                chart1.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y));

                chart2.append("defs").append("clipPath")
                    .attr("id", "clip2")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart2.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y2(0) + ")")
                    .call(d3.axisBottom(x2));
                chart2.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y2));

                chart3.append("defs").append("clipPath")
                    .attr("id", "clip3")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart3.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y2(0) + ")")
                    .call(d3.axisBottom(x2));
                chart3.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y2));

                chart4.append("defs").append("clipPath")
                    .attr("id", "clip4")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart4.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y(0) + ")")
                    .call(d3.axisBottom(x));
                chart4.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y));
/*

                chart5.append("defs").append("clipPath")
                    .attr("id", "clip5")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart5.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y2(0) + ")")
                    .call(d3.axisBottom(x));
                chart5.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y2));

                chart6.append("defs").append("clipPath")
                    .attr("id", "clip6")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);
                chart6.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + y3(0) + ")")
                    .call(d3.axisBottom(x2));
                chart6.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y3));
*/

                chart0.append("g")
                    .attr("clip-path", "url(#clip0)")
                    .append("path")
                    .datum(data0)
                    .attr("class", "line")
                    .transition()
                    .duration(50)
                    .ease(d3.easeLinear)
                    .on("start", tick0);

                chart1.append("g")
                    .attr("clip-path", "url(#clip1)")
                    .append("path")
                    .datum(data1)
                    .attr("class", "line")
                    .transition()
                    .duration(50)
                    .ease(d3.easeLinear)
                    .on("start", tick1);
                chart2.append("g")
                    .attr("clip-path", "url(#clip2)")
                    .append("path")
                    .datum(data2)
                    .attr("class", "line")
                    .attr("d", line2);

                chart3.append("g")
                    .attr("clip-path", "url(#clip3)")
                    .append("path")
                    .datum(data3)
                    .attr("class", "line")
                    .attr("d", line2);


                chart4.append("g")
                    .attr("clip-path", "url(#clip4)")
                    .append("path")
                    .datum(data4)
                    .attr("class", "line")
                    .transition()
                    .duration(50)
                    .ease(d3.easeLinear)
                    .on("start", tick4);

/*
                chart5.append("g")
                    .attr("clip-path", "url(#clip5)")
                    .append("path")
                    .datum(data5)
                    .attr("class", "line")
                    .transition()
                    .duration(50)
                    .ease(d3.easeLinear)
                    .on("start", tick5);

                chart6.append("g")
                    .attr("clip-path", "url(#clip6)")
                    .append("path")
                    .attr("id","path_6")
                    .datum(data6)
                    .attr("class", "line")
                    .transition()
                    .duration(500)
                    .ease(d3.easeLinear)
                    .on("start", tick6);
*/
            }


            function tick0() {
                if (in0.length > 49) {                 // Push a new data point onto the back.
                    for (var i = 0; i < 50; i++) {
                        data0.push(in0.shift());
                    }
                    d3.select(this)                     // Redraw the line.
                        .attr("d", line)
                        .attr("transform", null);
                    // Slide it to the left.
                    d3.active(this)
                        .attr("transform", "translate(" + x(-1) + ",0)")
                        .transition()
                        .on("start", tick0);
                    for (var i = 0; i < 50; i++) {
                        data0.shift();                    // Pop the old data point off the front.
                    }
                }
            }

            function tick1() {
                if (in1.length > 49) {                 // Push a new data point onto the back.
                    for (var i = 0; i < 50; i++) {
                        data1.push(in1.shift());
                    }
                    d3.select(this)                     // Redraw the line.
                        .attr("d", line)
                        .attr("transform", null);
                    // Slide it to the left.
                    d3.active(this)
                        .attr("transform", "translate(" + x(-1) + ",0)")
                        .transition()
                        .on("start", tick1);
                    for (var i = 0; i < 50; i++) {
                        data1.shift();                    // Pop the old data point off the front.
                    }
                }
            }

/*
            function tick2() {
                if (in2.length > 49) {                 // Push a new data point onto the back.
                    for (var i = 0; i < 50; i++) {
                        data2.push(in2.shift());
                    }
                    d3.select(this)                     // Redraw the line.
                        .attr("d", line)
                        .attr("transform", null);
                    // Slide it to the left.
                    d3.active(this)
                        .attr("transform", "translate(" + x(-1) + ",0)")
                        .transition()
                        .on("start", tick2);
                    for (var i = 0; i < 50; i++) {
                        data2.shift();                    // Pop the old data point off the front.
                    }
                }
            }

            function tick3() {
                if (in3.length > 49) {                 // Push a new data point onto the back.
                    for (var i = 0; i < 50; i++) {
                        data3.push(in3.shift());
                    }
                    d3.select(this)                     // Redraw the line.
                        .attr("d", line)
                        .attr("transform", null);
                    // Slide it to the left.
                    d3.active(this)
                        .attr("transform", "translate(" + x(-1) + ",0)")
                        .transition()
                        .on("start", tick3);
                    for (var i = 0; i < 50; i++) {
                        data3.shift();                    // Pop the old data point off the front.
                    }
                }
            }
*/

            function tick4() {
                if (in2.length > 49) {                 // Push a new data point onto the back.
                    console.log("data4 = "+data4);
                    console.log("in4 = "+in2);
                    for (var i = 0; i < 50; i++) {
                        data4.push(in2.shift());
                    }
                    d3.select(this)                     // Redraw the line.
                        .attr("d", line)
                        .attr("transform", null);
                    // Slide it to the left.
                    d3.active(this)
                        .attr("transform", "translate(" + x(-1) + ",0)")
                        .transition()
                        .on("start", tick4);
                    for (var i = 0; i < 50; i++) {
                        data4.shift();                    // Pop the old data point off the front.
                    }
                }
            }
        };

        this.version = function (msg) {
        };
        this.stop = function (msg) {
        };
        this.close = function (msg) {
        }

    };

    // Process the server messages related with exceptions
    sys = new function () {
        this.exception = function (msg) {
            alert(msg.toString());
        }
    };

    console.log("end of script");
</script>

<body>
<section style="width:90%;height:33%;margin:auto; ">
    <svg id="RAW_LEFT" width="600" height="263"></svg>
    <svg id="RAW_RIGHT" width="600" height="263"></svg>
</section>
<section style="width:90%;height:33%;margin:auto ">
    <svg id="EEG_LEFT" width="600" height="263"></svg>
    <svg id="EEG_RIGHT" width="600" height="263"></svg>
</section>
<section style="width:90%;height:33%;margin:auto ">
    <svg id="PPG" width="600" height="263"></svg>
    <svg id="HR" width="600" height="263"></svg>
</section>
<section style="width:90%;height:33%;margin:auto;">
    <svg id="ACC_X" width="600" height="263"></svg>
    <svg id="ACC_Y" width="600" height="263"></svg>
</section>
<section style="width:90%;height:33%;margin:auto ">
    <svg id="ACC_Z" width="600" height="263"></svg>
</section>
</body>

</html>